---
title: "Analyse NDVI tentative 1354"
author: "Youna DOUCHET - Bastien CL…MOT"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(lubridate)
library(corrplot)
library(ggplot2)
setwd("C:/Users/youy0/Desktop/master/PhD track/NDVI/nouveau_GLM")
```

Le but de cette analyse est de mettre en relation le NDVI avec les autres variables environnementales telles que les pr√©cipitations, la temp√©rature, les d√©bits et l'humidit√©. Nous souhaitons voir quelles variables permettent d'expliquer ce NDVI, notamment afin de comprendre pourquoi nos observations entre les effets de la s√©cheresse sur le NDVI et sur les d√©bits sont si diff√©rentes.  
Pour rappel: le d√©bit du Couesnon ne montre pas de signe d'une grosse s√©cheresse alors que le NDVI semble montrer une r√©ponse plut√¥t importante de la v√©g√©tation.  
  
Pour cette analyse, L√©a a extrait les NDVI moyens sur 15 jours pour l'ensemble du bassin versant. Pour une prochaine analyse nous avons aussi ces NDVI √† l'√©chelle de la tourbi√®re de Landemarais et du marais de Soug√©al ce qui pourrait nous montrer les diff√©rences de r√©ponses entre les deux sites.
  
  
Pour analyser les donn√©es nous allons utiliser les mod√®les lin√©aires g√©n√©ral ou g√©n√©ralis√©s. Les variables journali√®res ($X$) √† disposition sont:  
- **RH2M** = humidit√© √† 2M au dessus du sol  
- **T2M** = temp√©rature √† 2M au dessus du sol  
- **TS** = temp√©rature du sol  
- **precip** = precipitations sur l'ensemble du BV  
- **Debits** = d√©bits du Couesnon  
Nous voulons expliquer la variable $Y$ qui est le NDVI moyen √† l'√©chelle du BV:
$$ NDVI \approx RH2M + T2M + TS + precip + Debits$$

Remarque: Un mod√®le lin√©aire doit respecter certaines conditions notamment:   
- l'ind√©pendance des donn√©es  
- la relation lin√©aire entre la variable de r√©ponse et les variables explicatives  
- la stabilit√© des r√©sidus (homog√©n√©it√© des variances, normalit√© des r√©sidus)  
- pas de colin√©arit√© entre les variables explicatives
Les deux derni√®res conditions sont test√©es √† post√©riorit, apr√®s la construction du mod√®le. La premi√®re condition d√©pend de l'√©chantillonnage, dans notre cas les donn√©es sont bien ind√©pendanttes ????  
Dans notre cas il y aura s√ªrement de la colin√©arit√© entre nos variables, cela sera test√© en calculant les corr√©lations.   
  
  
Enfin, dans notre cas, plusieurs variables sont possibles pour chaque donn√©es climatiques. Par exemple pour les pr√©cipitations, le NDVI sera - t -il mieux pr√©dit pas les pr√©cipitations sur les 15 jours pr√©c√©dant la date de fin? sur les 20 jours? sur les 25?...  
Pour d√©terminer les variables s√©l√©ctionn√©es, nous feront des regressions lin√©aires pour voir quelles dur√©es ont les meilleures corr√©lations avec le NDVI. 


# 1. Import des Donn√©es & formatage

```{r}
humidite <- read.csv("humidite.csv")
ndvi <- read.table("NDVI_15j_LEA_nouveau_sept.txt",header = TRUE,stringsAsFactors = TRUE, na.strings = "NA",dec = ",")
precip <- read.csv("precip.csv")
deb_couesnon <- read.csv("deb_couesnon.csv")

#format de la colonne "Date"  <- format date de r (package lubridate tr√®s cool)
precip$Date <- as.Date(precip$Date,"%Y-%m-%d")
humidite$Date <- as.Date(humidite$Date,"%Y-%m-%d")
ndvi$Debut <- as.Date(ndvi$Debut,"%Y-%m-%d") #la colonne d√©but correspond au premier jour compt√© dans la moyenne des 15 jours pour le NDVI
ndvi$Date <- as.Date(ndvi$Fin)
ndvi$Fin <- as.Date(ndvi$Fin,"%Y-%m-%d") #idem mais dernier jours
deb_couesnon$Date <- as.Date(deb_couesnon$Date,"%Y-%m-%d")

colnames(precip) <- c("Date","precip")

```
On veut associer √† chaque valeur de NDVI les valeurs des variables environnementales. Pour le premier essai, on associe les moyennes sur les 15 jour du NDVI. 

```{r}
L <- list()
for (i in seq(15,60,5)) {
  temp <- deb_couesnon
  for (j in i:length(temp$Debits)) {
    temp$Debits[j]<- mean(temp$Debits[(j-i):j])
  }
  L[[as.character(i)]] <- left_join(x = ndvi,y = temp, by = "Date")
  temp <- humidite
  for (k in i:length(temp$RH2M)) {
    temp$RH2M[k] <- mean(temp$RH2M[(k-i):k])
    temp$T2M[k]<- mean(temp$T2M[(k-i):k])
    temp$TS[k]<- mean(temp$TS[(k-i):k])
    temp$T2M_MAX[k]<- mean(temp$T2M_MAX[(k-i):k])
    temp$T2M_MIN[k]<- mean(temp$T2M_MIN[(k-i):k])
    
  }
  L[[as.character(i)]] <- left_join(x = L[[as.character(i)]],y = temp, by = "Date")
  temp <- precip
  for (m in i:length(temp$precip)) {
    temp$precip[m]<- mean(temp$precip[(m-i):m])
    
  }
  L[[as.character(i)]] <- left_join(x = L[[as.character(i)]],y = temp, by = "Date")
  
}

```

# 2. Eploration des donn√©es

## a. Donn√©es de NDVI :

D'abord une repr√©sentation au cours du temps pour s√©lectionner les mois o√π la v√©g√©tation est active

```{r}

ggplot(L[[1]])+
  geom_line(aes(x = yday(Date), y = NDVI_moyen_BV, color = as.factor(year(Date))))+
  theme_classic()
```



```{r}
par(mfrow=c(2,2))
# Boxplot
boxplot(L[[1]]$NDVI_moyen_BV,col='blue',ylab='NDVI moyen')
# Cleveland plot
dotchart(L[[1]]$NDVI_moyen_BV,pch=16,col='blue',xlab='NDVI moyen')
# Histogram
hist(L[[1]]$NDVI_moyen_BV,col='blue',xlab="NDVI moyen",main="")
# Quantile-Quantile plot
qqnorm(L[[1]]$NDVI_moyen_BV,pch=16,col='blue',xlab='')
qqline(L[[1]]$NDVI_moyen_BV,col='red')
```

Dans les deux premiers graphes on voir qu'acun point ne semble abb√©rant. Dans le second, on voit que la variable Y semble se rappocher d'une loi normale --> demander √† L√©a/Tatiana 

## Donn√©es humidit√©

```{r, fig.height=7, fig.width=7}

for (i in 1:length(L)) {
  par(mfrow=c(4,3))
  # Humidit√© moyenne
  # Cleveland plot
  dotchart(L[[i]]$RH2M,pch=16,col='blue',xlab=paste0("Humidit√© moyenne √† 2m sur ",names(L[i])," jours "))
  # Histogram
  hist(L[[i]]$RH2M,col='blue',xlab=paste0("Humidit√© moyenne √† 2m sur ",names(L[i])," jours "),main="")
  # Quantile-Quantile plot
  qqnorm(L[[i]]$RH2M,pch=16,col='blue',xlab='')
  qqline(L[[i]]$RH2M,col='red')

  # Temp√©rature de l'air
  # Cleveland plot
  dotchart(L[[i]]$T2M,pch=16,col='blue',xlab=paste0("Temperature de l'air sur ",names(L[i])," jours "))
  # Histogram
  hist(L[[i]]$T2M,col='blue',xlab= paste0("Temperature de l'air sur ",names(L[i])," jours "),main="")
  # Quantile-Quantile plot
  qqnorm(L[[i]]$T2M,pch=16,col='blue',xlab='')
  qqline(L[[i]]$T2M,col='red')
  
  # Precipitations
  # Cleveland plot
  dotchart(L[[i]]$precip,pch=16,col='blue',xlab=paste0("Precipitations moyennes sur ",names(L[i])," jours "))
  # Histogram
  hist(L[[i]]$precip,col='blue',xlab= paste0("Precipitations moyennes sur ",names(L[i])," jours "),main="")
  # Quantile-Quantile plot
  qqnorm(L[[i]]$precip,pch=16,col='blue',xlab='')
  qqline(L[[i]]$precip,col='red')
  
  # D√©bits
  # Cleveland plot
  dotchart(L[[i]]$Debits,pch=16,col='blue',xlab=paste0("D√©bits moyens sur ",names(L[i])," jours "))
  # Histogram
  hist(L[[i]]$Debits,col='blue',xlab= paste0("D√©bits moyens sur ",names(L[i])," jours "),main="")
  # Quantile-Quantile plot
  qqnorm(L[[i]]$Debits,pch=16,col='blue',xlab='')
  qqline(L[[i]]$Debits,col='red')
  
}


```
2 points un peu louches, mais si t <0 alors sol sec donc peut √™tre ok?

## Analyse des relations potentielles entre les variables environnementales et le NDVI

```{r, fig.height=7, fig.width=7}
for (i in 1:length(L)) {
  par(mfrow = c(2,2))
  # Humidit√© air
  plot(L[[i]]$NDVI_moyen_BV ~L[[i]]$RH2M,pch=16,col='blue',xlab=paste0('Humidit√© moyenne sur ',   names(L[i])," jours"),ylab='NDVI moyen du BV sur 15 jours')
  #temp√©rature du sol
  plot(L[[i]]$NDVI_moyen_BV ~L[[i]]$T2M,pch=16,col='blue',xlab=paste0('Temp√©rature moyenne du     sol sur ', names(L[i])," jours"),ylab='NDVI moyen du BV sur 15 jours')
  #Precipitations
  plot(L[[i]]$NDVI_moyen_BV ~L[[i]]$precip,pch=16,col='blue',xlab=paste0('precipitations moyenne sur ', names(L[i])," jours"),ylab='NDVI moyen du BV sur 15 jours')
  #D√©bits
  plot(L[[i]]$NDVI_moyen_BV ~L[[i]]$Debits,pch=16,col='blue',xlab=paste0('D√©bits moyens du sur ', names(L[i])," jours"),ylab='NDVI moyen du BV sur 15 jours')
}
```
C'est globalement le bordel, on essaie en ne gardant que les mois d'activit√© des plantes (arbitrairement pour l'instant avril √† Septembre)

```{r, fig.height=7, fig.width=7}
for (i in 1:length(L)) {
  par(mfrow = c(2,2))
  # Humidit√© air
  plot(L[[i]][month(L[[i]]$Debut) >= 4 & month(L[[i]]$Fin) <=9,"NDVI_moyen_BV"] ~L[[i]][month(L[[i]]$Debut) >= 4 & month(L[[i]]$Fin) <=9,"RH2M"],pch=16,col='blue',xlab=paste0('Humidit√© moyenne sur ',   names(L[i])," jours"),ylab='NDVI moyen du BV sur 15 jours')
  #temp√©rature air
  plot(L[[i]][month(L[[i]]$Debut) >= 4 & month(L[[i]]$Fin) <=9,"NDVI_moyen_BV"] ~L[[i]][month(L[[i]]$Debut) >= 4 & month(L[[i]]$Fin) <=9,"T2M"],pch=16,col='blue',xlab=paste0('Temp√©rature moyenne du sol sur ', names(L[i])," jours"),ylab='NDVI moyen du BV sur 15 jours')
  #Pr√©cipitations
  plot(L[[i]][month(L[[i]]$Debut) >= 4 & month(L[[i]]$Fin) <=9,"NDVI_moyen_BV"] ~L[[i]][month(L[[i]]$Debut) >= 4 & month(L[[i]]$Fin) <=9,"precip"],pch=16,col='blue',xlab=paste0('Pr√©cipitations moyennes sur ', names(L[i])," jours"),ylab='NDVI moyen du BV sur 15 jours')
  #D√©bit
  plot(L[[i]][month(L[[i]]$Debut) >= 4 & month(L[[i]]$Fin) <=9,"NDVI_moyen_BV"] ~L[[i]][month(L[[i]]$Debut) >= 4 & month(L[[i]]$Fin) <=9,"Debits"],pch=16,col='blue',xlab=paste0('D√©bits moyens sur ', names(L[i])," jours"),ylab='NDVI moyen du BV sur 15 jours')
}
```
MOUAI 